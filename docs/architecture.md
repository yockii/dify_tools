# 系统架构设计

## 系统架构
### 核心组件
- 后端：Go + goFiber
- 数据库：PostgreSQL（支持各类PostgreSQL兼容数据库）
- 缓存：Redis单机版
- 文件存储：本地文件系统

### 模块架构
#### 1. 核心模块 (core)
- 作用：提供基础设施和公共服务
- 组件：配置管理、日志管理、工具类库、中间件
- 特点：高复用性、低耦合度

#### 2. 用户模块 (user)
- 作用：处理用户认证和权限管理
- 组件：用户管理、角色管理、权限控制
- 特点：安全可靠、权限精细化

#### 3. 应用管理模块 (app)
- 作用：管理接入应用及其配置
- 组件：应用信息、密钥管理、配置管理
- 特点：灵活配置、安全隔离

#### 4. AI应用模块 (ai)
- 作用：AI模型管理和调用
- 组件：模型管理、场景配置、调用管理
- 特点：可扩展、易配置

#### 5. 工具模块 (tool)
- 作用：提供各类工具服务
- 组件：数据库查询、网络搜索等
- 特点：插件化、易扩展

#### 6. 集成模块 (integration)
- 作用：对接第三方服务
- 组件：钉钉集成、定时任务等
- 特点：统一接口、易适配

#### 7. 监控模块 (monitor)
- 作用：系统监控和运维支持
- 组件：性能监控、业务监控、告警
- 特点：实时监控、及时告警

### 接口分层设计
#### 1. 系统内部接口层
- 用途：系统管理页面使用
- 认证：Bearer Token认证
- 安全：基于RBAC的权限控制
- 功能：用户管理、应用管理、AI应用管理等

#### 2. Dify对接接口层
- 用途：供Dify平台调用的工具接口
- 认证：API Key认证
- 安全：IP白名单、请求签名
- 功能：数据库查询、联网查询等工具

#### 3. 应用调用接口层
- 用途：外部应用接入使用
- 认证：API Key认证
- 安全：接口限流、访问控制
- 功能：文本生成、对话系统、钉钉集成等

## 数据流设计
### 1. 系统内部数据流
- Web界面 -> 系统内部接口 -> 业务逻辑 -> 数据持久化
- 权限验证 -> 数据操作审计 -> 结果返回

### 2. Dify工具调用流
- Dify平台 -> 工具接口 -> 工具处理 -> 结果返回
- API认证 -> 调用限制 -> 数据处理

### 3. 应用接入流
- 外部应用 -> 应用接口 -> AI处理 -> 结果返回
- 接口认证 -> 限流控制 -> 会话管理

## 技术实现
### 1. 数据存储
- PostgreSQL：业务数据存储
- Redis：缓存和会话管理
- 本地文件：日志和临时文件

### 2. 缓存策略
- 会话缓存：用户登录状态
- 数据缓存：常用配置信息
- 接口缓存：高频调用结果

### 3. 并发处理
- 协程池：管理goroutine
- 连接池：数据库连接
- 限流器：接口访问控制

## 安全设计
### 认证体系
- 系统内部：JWT Token认证
- 外部接口：API Key认证
- 会话管理：Redis存储

### 权限控制
- RBAC权限模型
- 接口级别权限
- 数据级别权限
- 操作审计日志

### 数据安全
- 传输加密（HTTPS）
- 敏感数据加密
- SQL注入防护
- XSS防护

## 监控设计
### 系统监控
- 服务健康状态
- 资源使用情况
- 接口响应时间
- 错误日志统计

### 业务监控
- 接口调用量
- AI模型使用情况
- 应用接入状态
- 用户活跃度

### 告警机制
- 服务异常告警
- 资源阈值告警
- 业务异常告警
- 安全事件告警

## 扩展设计
### 应用扩展
- 多节点部署
- 配置热更新
- 插件化功能

### 功能扩展
- 新增AI模型支持
- 工具接口扩展
- 三方集成接口

## 日志体系
### 日志分类
- 访问日志：接口调用记录
- 错误日志：异常信息记录
- 审计日志：关键操作记录
- 性能日志：性能指标记录

### 日志处理
- 本地文件存储
- 日志分割
- 定期清理
- 日志分析